  <?php
    if($_SESSION["role"] !== 'customer'){
    ?>
    <div class="wrapper w-full px-12 mx-5 dark:bg-[#18181b]">
      <section class="flex">
        <p class="dark:text-white">403: Access denied to this page</p>
      </section>
  <?php
    } else {
$labelClass = "leading-7 text-sm text-gray-600 dark:text-gray-300";
$inputClass = "w-full bg-gray-100 bg-opacity-50 rounded border border-gray-300 focus:border-indigo-500 focus:bg-white focus:ring-2 focus:ring-indigo-200 text-base outline-none text-gray-700 py-1 px-3 leading-8 transition-colors duration-200 ease-in-out dark:text-white dark:bg-[#1d1d21] dark:border-none"; 

$id = $_GET['id'] ?? '';
if(!empty($id)){
  $sql = mysqli_query($conn, "SELECT * FROM customers WHERE id=$id");
  $row = mysqli_fetch_assoc($sql);
}
?>
<section class="flex">
    <div class="wrapper w-full px-12 mx-5 dark:bg-[#18181b]">
        <form action="" id="form" class="dark:text-gray-100">
          <div class="my-5">
            <h1 class="text-3xl text-gray-700 dark:text-gray-100">New Loan</h1>
          </div>
          <hr class="mb-4 border-gray-700">
                <input id='customerId' value="<?=$_GET['id'] ?? '' ?>" hidden>
                <div class="relative">
                  <label for="customer_id" class="<?=$labelClass ?>">Customer</label>
                  <input required type="text" value="<?=$_SESSION['user_id']?>" id="customer_id" name="customer_id" class="<?=$inputClass ?>">
                  <!-- <select required id="customer_id" name="customer_id" class="<?=$inputClass ?>">
                    <option value="">Select Customer</option>
                    <?php
                      // Fetch customers from database
                      $customers_query = "SELECT id, CONCAT(first_name, ' ', last_name) AS full_name FROM customers";
                      $customers_result = mysqli_query($conn, $customers_query);
                      if(mysqli_num_rows($customers_result) > 0){
                        while($customer_row = mysqli_fetch_assoc($customers_result)){
                          $selected = ($customer_row['id'] == $row['id']) ? 'selected' : '';
                          echo "<option value='{$customer_row['id']}' {$selected}>{$customer_row['full_name']}</option>";
                        }
                      }
                    ?>
                  </select> -->
                </div>
                <div class="relative">
                  <label for="loan_type" class="<?=$labelClass ?>">Loan Type</label>
                  <input required type="text" id="loan_type" name="loan_type" placeholder="e.g. Personal Loan" class="<?=$inputClass ?>">
                </div>
                <div class="relative">
                  <label for="loan_amount" class="<?=$labelClass ?>">Loan Amount</label>
                  <input required type="number" id="loan_amount" name="loan_amount" placeholder="Loan Amount" class="<?=$inputClass ?>">
                </div>
                <div class="relative">
                  <label for="interest_rate" class="<?=$labelClass ?>">Interest Rate (%)</label>
                  <input required type="number" id="interest_rate" name="interest_rate" placeholder="Interest Rate" class="<?=$inputClass ?>">
                </div>
                <div class="relative">
                  <label for="term" class="<?=$labelClass ?>">Term (months)</label>
                  <input required type="number" id="term" name="term" placeholder="Loan Term" class="<?=$inputClass ?>">
                </div>
                <!-- 
                <div class="relative">
                  <label for="start_date" class="<?=$labelClass ?>">Start Date</label>
                  <input required type="date" id="start_date" name="start_date" class="<?=$inputClass ?>">
                </div>
                <div class="relative">
                  <label for="end_date" class="<?=$labelClass ?>">End Date</label>
                  <input required type="date" id="end_date" name="end_date" class="<?=$inputClass ?>">
                </div> -->
                <!-- <div class="relative">
                  <label for="status" class="<?=$labelClass ?>">Status</label>
                  <select required id="status" name="status" class="<?=$inputClass ?>">
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                  </select>
                </div> -->
                <div class="relative py-4 mt-3">
                  <button class="block border-none h-fit text-sm p-2 py-2 bg-indigo-600 hover:bg-indigo-800 rounded-sm text-white rounded-sm"><?=($_GET['id'] ?? 0)? 'Update Loan' : 'Add Loan' ?></a>
                </div>
        </form>
    </div>
</section>
<!-- 
     a script to get all input values as an object on form submit and
     send then submit it to http://localhost:3000/api/loans/ 
     method POST
-->
<script type="text/javascript">
  const MyForm = document.getElementById('form');
  MyForm.addEventListener('submit', (e)=>{
    method = 'POST';
    let url = "/api/?modelName=loans";
    e.preventDefault();
    //var startDate = new Date(start_date.value);
    //var endDate = new Date(end_date.value);
    let submit = {
    customer_id: parseInt(customer_id.value),
    loan_type: loan_type.value,
    loan_amount: parseInt(loan_amount.value),
    interest_rate: interest_rate.value,
    term: parseInt(term.value),
    //start_date: startDate.toISOString(),
    //end_date:   endDate.toISOString(),
    //status:     status.value,
    }
    /*if(customerId.value !== ''){
      url = "http://localhost:3000/api/loans/" + parseInt(customerId.value);
      method = 'PUT';
    }*/
    DataSubmitter(method, url, submit);
  })
</script>
<?php
}
?>